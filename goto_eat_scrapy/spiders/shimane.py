import re
import scrapy
from logzero import logger
from goto_eat_scrapy.items import ShopItem

class shimaneSpider(scrapy.Spider):
    """
    usage:
      $ scrapy crawl shimane -O 32_shimane.csv
    """
    name = 'shimane'
    allowed_domains = [ 'gotoeat-shimane.jp' ]

    start_urls = ['https://www.gotoeat-shimane.jp/inshokuten/']

    def parse(self, response):
        # è©³ç´°ãƒšãƒ¼ã‚¸ã‹ã‚‰å„åŠ ç›Ÿåº—æƒ…å ±ã‚’æŠ½å‡º
        for article in response.xpath('//div[@id="main"]//div[@class="com-location"]/ul/li'):
            url = article.xpath('.//a/@href').get()
            yield scrapy.Request(response.urljoin(url), callback=self.detail)

        # ã€Œ>ã€ãƒœã‚¿ãƒ³ãŒãªã‘ã‚Œã°(æœ€çµ‚ãƒšãƒ¼ã‚¸ãªã®ã§)çµ‚äº†
        next_page = response.xpath('//nav[@class="pagination"]/span[@class="next"]/a[@rel="next"]/@href').extract_first()
        if next_page is None:
            logger.info('ğŸ’» finished. last page = ' + response.request.url)
            return

        next_page = response.urljoin(next_page)
        logger.info(f'ğŸ›« next url = {next_page}')

        yield scrapy.Request(next_page, callback=self.parse)

    def detail(self, response):
        item = ShopItem()
        item['shop_name'] = response.xpath('//h1[@class="title"]/text()').get().strip()
        item['address'] = response.xpath('//div[@class="info line addr"]/p/text()').get().strip()
        item['offical_page'] = response.xpath('//div[@class="info line url"]/p/text()').get()
        item['genre_name'] = self._genre(response.xpath('//div[@class="info select genre"]/p/span/text()').get().strip())

        tel = response.xpath('//div[@class="info line tel"]/p/text()').get()
        item['tel'] = tel.strip() if tel else None

        yield item

    def _genre(self, genre_name: str):
        # ãã®ä»–ã®ã‚¸ãƒ£ãƒ³ãƒ«ãŒå¤šã™ãã‚‹ã®ã§é›†ç´„
        # ã‚‚ã—ã‹ã—ãŸã‚‰ "ãã®ä»–   \n   (ã‚«ãƒ•ã‚§)"ã¨ã„ã£ãŸæ›¸å¼ãªã®ã‹ã‚‚
        genre_name = ''.join(genre_name.split())
        if genre_name.startswith('ãã®ä»–'):
            return 'ãã®ä»–'

        return genre_name

        # TODO: ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ã‚ãŸã‚Šã¯é€šå¸¸ã‚¸ãƒ£ãƒ³ãƒ«ã«ã—ã¦ã‚‚ã„ã„ã‹ã‚‚ã—ã‚Œãªã„ã€ãŸã åˆ†é¡ãŒè¬
        #
        # [I 201118 19:20:01 main:121] genre_name=å±…é…’å±‹
        # [I 201118 19:20:01 main:121] genre_name=å’Œé£Ÿãƒ»æ—¥æœ¬æ–™ç†
        # [I 201118 19:20:01 main:121] genre_name=ç„¼è‚‰ãƒ»ãƒ›ãƒ«ãƒ¢ãƒ³
        # [I 201118 19:20:01 main:121] genre_name=ãƒ©ãƒ¼ãƒ¡ãƒ³
        # [I 201118 19:20:01 main:121] genre_name=ãã®ä»–ï¼ˆã‚«ãƒ•ã‚§ï¼‰
        # [I 201118 19:20:02 main:121] genre_name=å®šé£Ÿãƒ»é£Ÿå ‚
        # [I 201118 19:20:02 main:121] genre_name=ãã®ä»–ï¼ˆå¤æ°‘å®¶ã‚«ãƒ•ã‚§ï¼‰
        # [I 201118 19:20:02 main:121] genre_name=å¯¿å¸
        # [I 201118 19:20:02 main:121] genre_name=ã‚¤ã‚¿ãƒªã‚¢ãƒ³ãƒ»ãƒ•ãƒ¬ãƒ³ãƒ
        # [I 201118 19:20:02 main:121] genre_name=ãƒ€ã‚¤ãƒ‹ãƒ³ã‚°ãƒãƒ¼ãƒ»ãƒãƒ«
        # [I 201118 19:20:02 main:121] genre_name=ä¸­è¯ãƒ»å°æ¹¾æ–™ç†
        # [I 201118 19:20:02 main:121] genre_name=ãã°ãƒ»ã†ã©ã‚“
        # [I 201118 19:20:02 main:121] genre_name=å„å›½æ–™ç†ãƒ»å¤šå›½ç±æ–™ç†
        # [I 201118 19:20:02 main:121] genre_name=ãã®ä»–ï¼ˆãœã‚“ã–ã„ï¼‰
        # [I 201118 19:20:02 main:121] genre_name=ãã®ä»–ï¼ˆãƒ‘ãƒ³ï¼‰
        # [I 201118 19:20:02 main:121] genre_name=ãã®ä»–ï¼ˆå–«èŒ¶åº—ï¼‰
        # [I 201118 19:20:02 main:121] genre_name=å‰µä½œæ–™ç†
        # [I 201118 19:20:02 main:121] genre_name=ãã®ä»–ï¼ˆã‚µãƒ©ãƒ€å±‹ï¼‰
        # [I 201118 19:20:02 main:121] genre_name=ãŠå¥½ã¿ç„¼ããƒ»ãŸã“ç„¼ã
        # [I 201118 19:20:02 main:121] genre_name=ãã®ä»–ï¼ˆæ—¥æœ¬èŒ¶ã‚«ãƒ•ã‚§ï¼‰
        # [I 201118 19:20:02 main:121] genre_name=ãã®ä»–ï¼ˆå–«èŒ¶ã€è»½é£Ÿï¼‰
        # [I 201118 19:20:02 main:121] genre_name=ãã®ä»–ï¼ˆå–«èŒ¶ï¼‰
        # [I 201118 19:20:02 main:121] genre_name=ãã®ä»–ï¼ˆèŒ¶å®¤ï¼‰
        # [I 201118 19:20:02 main:121] genre_name=ãã®ä»–ï¼ˆãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ãƒ»å¯¿å¸ãƒ»å±…é…’å±‹ï¼‰
        # [I 201118 19:20:02 main:121] genre_name=ãã®ä»–ï¼ˆæ´‹é¢¨å±…é…’å±‹ï¼‰
        # [I 201118 19:20:02 main:121] genre_name=æµ·é®®
        # [I 201118 19:20:02 main:121] genre_name=ãã®ä»–ï¼ˆã‚«ãƒ•ã‚§ãƒ»ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ï¼‰
        # [I 201118 19:20:02 main:121] genre_name=ãã®ä»–
        # [I 201118 19:20:02 main:121] genre_name=ãã®ä»–ï¼ˆãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ï¼‰
        # [I 201118 19:20:02 main:121] genre_name=ã‚«ãƒ¬ãƒ¼
        # [I 201118 19:20:02 main:121] genre_name=ãã®ä»–ï¼ˆãƒ‘ãƒ³ãƒ»ã‚µãƒ³ãƒ‰ã‚¦ã‚£ãƒƒãƒãƒ»ç„¼è“å­ï¼‰
        # [I 201118 19:20:02 main:121] genre_name=ãã®ä»–ï¼ˆç„¼è‚‰ãƒ»ã—ã‚ƒã¶ã—ã‚ƒã¶ãƒ»å±…é…’å±‹ãƒ»é£Ÿå ‚ï¼‰ï¼‰
        # [I 201118 19:20:02 main:121] genre_name=ãã®ä»–ï¼ˆè–¬è†³ã‚¹ãƒ¼ãƒ—ã‚«ãƒ¬ãƒ¼ï¼‰
        # [I 201118 19:20:02 main:121] genre_name=ãã®ä»–ï¼ˆã‚¯ãƒ©ãƒ•ãƒˆãƒ“ãƒ¼ãƒ«åº—ï¼‰
        # [I 201118 19:20:02 main:121] genre_name=ãã®ä»–ï¼ˆè•éº¦ã€ãã°å‰ã€æ—¥æœ¬é…’ï¼‰
        # [I 201118 19:20:02 main:121] genre_name=ãã®ä»–ï¼ˆãƒ•ãƒ¼ãƒ‰ã‚³ãƒ¼ãƒˆï¼‰
        # [I 201118 19:20:02 main:121] genre_name=ãã®ä»–ï¼ˆå’Œæ´‹å³¶ã®ã‚ªãƒªã‚¸ãƒŠãƒ«æ–™ç†ï¼‰
        # [I 201118 19:20:02 main:121] genre_name=ãã®ä»–ï¼ˆå–«èŒ¶ã€ç”˜å‘³ï¼‰
        # [I 201118 19:20:02 main:121] genre_name=ãã®ä»–ï¼ˆç‰›ãŸã‚“æ–™ç†å°‚é–€åº—ï¼‰
        # [I 201118 19:20:02 main:121] genre_name=ãã®ä»–ï¼ˆå–«èŒ¶ãƒ»è»½é£Ÿï¼‰
        # [I 201118 19:20:02 main:121] genre_name=ãã®ä»–ï¼ˆãƒ™ãƒ¼ã‚«ãƒªãƒ¼ã‚«ãƒ•ã‚§ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=éŸ“å›½æ–™ç†
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆã‚½ãƒ•ãƒˆã‚¯ãƒªãƒ¼ãƒ ã€ã‚³ãƒ­ãƒƒã‚±ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆãƒ™ã‚¸ã‚¿ãƒªã‚¢ãƒ³æ–™ç†ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆãƒ©ãƒ¼ãƒ¡ãƒ³ã€ç„¼ããã°ã€ä¸¼ã€ã†ã©ã‚“ã€ã‚«ãƒ¬ãƒ¼ä»–ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆã‚¹ãƒ†ãƒ¼ã‚­ãƒã‚¦ã‚¹ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆãƒ“ã‚¢ã‚¬ãƒ¼ãƒ‡ãƒ³ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆã‚«ãƒ•ã‚§ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆãƒ¯ã‚¤ãƒ³ã€å–«èŒ¶ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆã‚¹ã‚¤ãƒ¼ãƒ„ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆãƒ‘ãƒ³ãƒ»ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆãƒ»ã‚±ãƒ¼ã‚­ãƒ»ãƒ‰ãƒªãƒ³ã‚¯ä»–ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆãƒ•ãƒ©ã‚¤ãƒ‰ãƒã‚­ãƒ³ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆå’Œé£Ÿãƒ»æ´‹é£Ÿï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆæ´‹è“å­ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆãƒ•ã‚¡ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆãƒ‰ãƒ¼ãƒŠãƒ„ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆã‚¹ãƒ†ãƒ¼ã‚­ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼ä»–ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆã‚¢ã‚¤ã‚¹ã‚¯ãƒªãƒ¼ãƒ ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒ•ãƒ¼ãƒ‰(ãƒãƒ³ãƒãƒ¼ã‚¬ãƒ¼)ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆä¸€èˆ¬é£Ÿå ‚ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆã‚¯ãƒ¬ãƒ¼ãƒ—ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆã‚¹ãƒŠãƒƒã‚¯ï¼ˆæ¥å®¢ã‚’ä¼´ã‚ãªã„ï¼‰ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆãƒ•ã‚¡ãƒŸãƒªãƒ¼ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆã‚¢ã‚¤ã‚¹ãƒ»ã‚¯ãƒ¬ãƒ¼ãƒ—ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆã¨ã‚“ã‹ã¤ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆç„¼ãé³¥å±‹ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆã‚ªãƒ¼ã‚»ãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆãƒ‰ãƒªãƒ³ã‚¯ãƒ»ãƒ•ãƒ©ã‚¤ãƒ‰ãƒãƒ†ãƒˆï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆå–«èŒ¶ãƒ»ã‚«ãƒ•ã‚§ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆçˆç²ãƒ»è»½é£Ÿï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆç„¼ãã¨ã‚Šå±‹ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆãŠã°ã‚“ã–ã„ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆãƒã‚¤ã‚­ãƒ³ã‚°ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆã‚¬ãƒ‹ãƒƒã‚¯ã‚«ãƒ•ã‚§ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆã‚«ãƒ•ã‚§ã€å–«èŒ¶åº—ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆãƒ»è»½é£Ÿï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆã‚¢ã‚¤ã‚¹ã‚¯ãƒªãƒ¼ãƒ åŠã³å–«èŒ¶ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆæ³•è¦ä¼šå¸­ã€è»½é£Ÿï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆã‚³ãƒ¼ãƒ’ãƒ¼ãƒ“ãƒ¼ãƒ³ã‚ºã‚·ãƒ§ãƒƒãƒ—ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆè–¬è†³æ–™ç†ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆã‚½ãƒ•ãƒˆã‚¯ãƒªãƒ¼ãƒ åº—ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆãƒ´ã‚£ãƒ¼ã‚¬ãƒ³ãƒ¬ã‚¹ãƒˆãƒ©ãƒ³ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆã—ã‚ƒã¶ã—ã‚ƒã¶åº—ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆã—ã‚ƒã¶ã—ã‚ƒã¶ãƒ»ã™ãç„¼ããƒ»æ´‹é£Ÿï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆã¨ã‚“ã‹ã¤å°‚é–€åº—ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆã‚³ãƒ¼ãƒ’ãƒ¼åº—ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆæ˜çŸ³ç„¼ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆã†ãªãæ–™ç†ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆå‡ºé›²ãœã‚“ã–ã„åº—ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆãƒˆãƒ³ã‚«ãƒ„ï¼‰
        # [I 201118 19:20:03 main:121] genre_name=ãã®ä»–ï¼ˆ(ã‚«ãƒ•ã‚§ãƒ»å–«èŒ¶)ï¼‰
